message('src submenu')

subdir('appendix')
subdir('concepts')
subdir('dialogs')
subdir('filters')
subdir('glossary')
# # #subdir('images') # not a directory with xml files
subdir('introduction')
subdir('menus')
subdir('preface')
subdir('toolbox')
subdir('tutorial')
subdir('using')

# all_pots = custom_target('pot-all',
#     depends: [appendix_pot],
#     input:'',
#     output: 'pot-all',
#     command: [
#         'ls',
#     ],
#     build_by_default: true,
# )

# list of source files to make a pot from
pot_source_files = [
    'gimp.xml',
    'help-missing.xml',
    'introduction.xml',
    'key-reference.xml',
]
target     = 'gimp.pot'
target_pot = pot_base + target

# Debugging help...
message('Creating target for ' + target_pot)

gimp_pot = custom_target(target,
    #depends: [authors_doc],
    input: pot_source_files,
    output: [target],
    command: [
        xml2pot, target_pot, meson.build_root(), meson.source_root(), '@INPUT@',
    ],
    build_by_default: true,
)

xml_lang_base = meson.build_root() + '/xml'
po_source     = 'gimp.po'
# for each enabled language create a xml/lang/... target
foreach lang : target_linguas
    # Make lang directory if not existing
    run_command (
        'mkdir', '-p',
        xml_lang_base + '/' + lang,
    )

    # target per lang
    target_base = lang + '-'
    htmltarget = 'html-'+lang

    # en is a special case...
    if lang != 'en'
        foreach xmlfile : pot_source_files
            target = target_base + xmlfile
            #message(target)
            gimp_xml = custom_target(target,
                output: [target],
                command: [
                    xml2po,
                    '--po-file=' + meson.source_root() + '/po/' + lang + '/' + po_source,
                    '--language=' + lang,
                    '--output=' + meson.build_root() + '/xml/' + lang + '/' + xmlfile,
                    meson.source_root() + '/src/' + xmlfile,
                ],
                build_by_default: true,
            )
        endforeach
    else
        #TODO English has no po files...
        foreach xmlfile : pot_source_files
            target = target_base + xmlfile
            lang_xml = meson.build_root()  + '/xml/' + lang + '/' + xmlfile
            #message(target)
            gimp_xml = custom_target(target,
                output: [target],
                command: [
                    'cp',
                    meson.source_root() + '/src/' + xmlfile,
                    #meson.build_root()  + '/xml/' + lang + '/' + xmlfile,
                    lang_xml,
                ],
                build_by_default: true,
            )

        endforeach
        gimp_html = custom_target(htmltarget,
            output: [htmltarget],
            command: [
                xsltproc,
                '--verbose',
                #'--timing',
                '--nonet',
                '--path', meson.build_root(),
                '--path', meson.build_root()+'/xml/images',  # testing if this helps
                '--xinclude',
                '--stringparam', 'l10n.gentext.default.language ', lang,
                '--output', 'html/' + lang + '/',
                'stylesheets/plainhtml.xsl', #TODO refer to source??? or copy first!
                'xml/' + lang + '/gimp.xml',
                #meson.source_root() + '/src/' + xmlfile,
                #meson.build_root()  + '/xml/' + lang + '/' + xmlfile,
            ],
            build_by_default: true,
        )
    endif
endforeach
